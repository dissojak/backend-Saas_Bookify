<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>All Users - Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
        }

        .back-btn {
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .content {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: rgba(255, 255, 255, 0.6);
        }

        .error {
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid rgba(233, 69, 96, 0.4);
            color: #ff6b6b;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }
        .filter-input, .filter-select {
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 13px;
        }
        .filter-btn { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: #4ecca3; color: #000; font-weight: 700; cursor: pointer; }
        .action-btn { padding: 6px 10px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; margin-right: 6px; }
        .action-btn.status { background: #4ecca3; color: #000; }
        .action-btn.ban { background: #e94560; color: #fff; }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            padding: 14px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        td {
            padding: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
        }

        .role-admin { background: rgba(233, 69, 96, 0.3); color: #e94560; }
        .role-business_owner { background: rgba(78, 204, 163, 0.3); color: #4ecca3; }
        .role-client { background: rgba(79, 70, 229, 0.3); color: #8b7fff; }

        .verified {
            color: #4ecca3;
            font-weight: 600;
        }

        .not-verified {
            color: #ff6b6b;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 150px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #4ecca3;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }
    </style>
</head>
<body>
<script>
// ============ INLINE TOAST NOTIFICATION SYSTEM ============
(function() {
    const style = document.createElement('style');
    style.textContent = `
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        @keyframes toastSlideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes toastSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    function getContainer() {
        let container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            document.body.appendChild(container);
        }
        return container;
    }

    window.showToast = function(message, type, duration) {
        type = type || 'info';
        duration = duration !== undefined ? duration : 4000;

        const container = getContainer();
        const toast = document.createElement('div');

        const colors = {
            success: { bg: '#10b981', border: '#059669', icon: '‚úì' },
            error: { bg: '#ef4444', border: '#dc2626', icon: '‚úï' },
            warning: { bg: '#f59e0b', border: '#d97706', icon: '‚ö†' },
            info: { bg: '#3b82f6', border: '#2563eb', icon: '‚Ñπ' }
        };
        const c = colors[type] || colors.info;

        toast.style.cssText = `
            background: ${c.bg};
            border: 1px solid ${c.border};
            color: #fff;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toastSlideIn 0.3s ease;
            cursor: pointer;
        `;

        toast.innerHTML = '<span style="font-size:18px;font-weight:bold;">' + c.icon + '</span><span>' + message + '</span>';
        container.appendChild(toast);

        const remove = function() {
            toast.style.animation = 'toastSlideOut 0.3s ease';
            setTimeout(function() { toast.remove(); }, 300);
        };

        toast.addEventListener('click', remove);
        if (duration > 0) setTimeout(remove, duration);

        return toast;
    };

    console.log('Toast system initialized');
})();

// ============ AUTHENTICATION CHECK ============
const accessToken = localStorage.getItem('accessToken');
if (!accessToken) {
    console.warn('No access token found, redirecting to login');
    window.location.href = 'LoginAdmin.html';
}
</script>

<div class="container">
    <div class="header">
        <div class="header-title">üë• All Users</div>
        <a href="Dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
    </div>

    <div id="errorContainer"></div>

    <div class="content">
        <div id="loadingContainer" class="loading">Loading users...</div>

        <div id="usersContainer" style="display: none;">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="verifiedUsers">0</div>
                    <div class="stat-label">Verified</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="businessOwners">0</div>
                    <div class="stat-label">Business Owners</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="clients">0</div>
                    <div class="stat-label">Clients</div>
                </div>
            </div>

            <div class="filters">
                <input id="filterEmail" class="filter-input" type="text" placeholder="Search by email" />
                <input id="filterName" class="filter-input" type="text" placeholder="Search by name" />
                <input id="filterFrom" class="filter-input" type="datetime-local" placeholder="From date" />
                <input id="filterTo" class="filter-input" type="datetime-local" placeholder="To date" />
                <select id="filterRole" class="filter-select">
                    <option value="">All roles</option>
                    <option value="ADMIN">Admin</option>
                    <option value="BUSINESS_OWNER">Business Owner</option>
                    <option value="CLIENT">Client</option>
                </select>
                <select id="filterStatus" class="filter-select">
                    <option value="">All status</option>
                    <option value="VERIFIED">VERIFIED</option>
                    <option value="PENDING">Pending</option>
                    <option value="SUSPENDED">Suspended</option>
                    <option value="BANNED">Banned</option>
                </select>
                <button id="searchBtn" class="filter-btn">üîç Search</button>
                <button id="clearBtn" class="filter-btn" style="background:#3b82f6;color:#fff;">Clear</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th><th>Name</th><th>Email</th><th>Roles</th><th>Status</th><th>Created At</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const pathname = window.location.pathname || '/';
    const segments = pathname.split('/').filter(s => s.length > 0);
    let basePath = '';
    if (segments.length > 0) {
        const first = segments[0];
        if (!first.includes('.') && !first.toLowerCase().endsWith('.html')) {
            basePath = '/' + first;
        }
    }

    let allUsers = [];
    let currentFilter = 'all';

    async function fetchUsersWithFilters() {
        try {
            const params = new URLSearchParams();
            const email = document.getElementById('filterEmail').value.trim();
            const name = document.getElementById('filterName').value.trim();
            const from = document.getElementById('filterFrom').value;
            const to = document.getElementById('filterTo').value;
            const role = document.getElementById('filterRole').value;
            const status = document.getElementById('filterStatus').value;

            if (email) params.append('email', email);
            if (name) params.append('name', name);
            if (from) params.append('fromDate', from);
            if (to) params.append('toDate', to);
            if (role) params.append('role', role);
            if (status) params.append('status', status);

            const url = `${basePath}/v1/admin/users/search?${params.toString()}`;
            console.log('Fetching users from:', url);

            const res = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                }
            });

            console.log('Response status:', res.status);

            if (!res.ok) {
                let errorMsg;
                try {
                    const errorData = await res.json();
                    errorMsg = errorData.error || errorData.message || `HTTP ${res.status}`;
                } catch (e) {
                    errorMsg = `HTTP ${res.status}`;
                }
                throw new Error(errorMsg);
            }

            allUsers = await res.json();
            console.log('Users loaded:', allUsers.length);
        } catch (error) {
            console.error('Error in fetchUsersWithFilters:', error);
            throw error;
        }
    }

    async function changeUserStatus(userId, newStatus) {
        try {
            console.log('Changing user', userId, 'status to', newStatus);
            const res = await fetch(`${basePath}/v1/admin/users/${userId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (!res.ok) {
                let errorMsg;
                try {
                    const errorData = await res.json();
                    errorMsg = errorData.error || errorData.message || `HTTP ${res.status}`;
                } catch (e) {
                    errorMsg = `HTTP ${res.status}`;
                }
                throw new Error(errorMsg);
            }

            showToast('User status updated successfully', 'success');
            await loadUsers();
        } catch (error) {
            console.error('Error changing user status:', error);
            showToast('Failed to update user status: ' + error.message, 'error');
        }
    }

    async function banUser(userId) {
        try {
            console.log('Banning user', userId);
            const res = await fetch(`${basePath}/v1/admin/users/${userId}/ban`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                }
            });

            if (!res.ok) {
                let errorMsg;
                try {
                    const errorData = await res.json();
                    errorMsg = errorData.error || errorData.message || `HTTP ${res.status}`;
                } catch (e) {
                    errorMsg = `HTTP ${res.status}`;
                }
                throw new Error(errorMsg);
            }

            showToast('User banned successfully', 'success');
            await loadUsers();
        } catch (error) {
            console.error('Error banning user:', error);
            showToast('Failed to ban user: ' + error.message, 'error');
        }
    }

    function displayUsers() {
        const tbody = document.getElementById('usersTable');
        let filtered = allUsers;
        if (currentFilter === 'verified') {
            filtered = allUsers.filter(u => (u.status || '').toUpperCase() === 'VERIFIED');
        } else if (currentFilter !== 'all') {
            filtered = allUsers.filter(u => (u.role || '').toUpperCase() === currentFilter);
        }
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">No users found</td></tr>';
            return;
        }
        tbody.innerHTML = filtered.map(user => `
            <tr>
                <td>${user.id}</td>
                <td><strong>${user.name || 'N/A'}</strong></td>
                <td>${user.email}</td>
                <td><span class="role-badge role-${(user.role || 'unknown').toLowerCase()}">${user.role || 'N/A'}</span></td>
                <td class="${user.status === 'VERIFIED' ? 'verified' : 'not-verified'}">${user.status || 'Unknown'}</td>
                <td>${user.createdAt ? new Date(user.createdAt).toLocaleString() : 'N/A'}</td>
                <td>
                    <button class="action-btn status" onclick="changeUserStatus(${user.id}, 'VERIFIED')">Set VERIFIED</button>
                    <button class="action-btn status" onclick="changeUserStatus(${user.id}, 'PENDING')">Set Pending</button>
                    <button class="action-btn status" onclick="changeUserStatus(${user.id}, 'SUSPENDED')">Set Suspended</button>
                    <button class="action-btn ban" onclick="banUser(${user.id})">Ban</button>
                </td>
            </tr>
        `).join('');
    }

    async function loadUsers() {
        try {
            await fetchUsersWithFilters();
            const businessOwners = allUsers.filter(u => u.role === 'BUSINESS_OWNER').length;
            const clients = allUsers.filter(u => u.role === 'CLIENT').length;
            document.getElementById('totalUsers').textContent = allUsers.length;
            document.getElementById('verifiedUsers').textContent = allUsers.filter(u => u.status === 'VERIFIED').length;
            document.getElementById('businessOwners').textContent = businessOwners;
            document.getElementById('clients').textContent = clients;
            displayUsers();
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('usersContainer').style.display = 'block';
        } catch (err) {
            console.error('Failed to load users:', err);
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('errorContainer').innerHTML = `<div class="error">‚ö†Ô∏è Failed to load users: ${err.message}</div>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Wire up search button
        document.getElementById('searchBtn').addEventListener('click', loadUsers);

        // Wire up clear button
        document.getElementById('clearBtn').addEventListener('click', () => {
            ['filterEmail','filterName','filterFrom','filterTo','filterRole','filterStatus'].forEach(id => {
                document.getElementById(id).value = '';
            });
            loadUsers();
        });

        // Allow pressing Enter in filter inputs to trigger search
        ['filterEmail', 'filterName'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadUsers();
                }
            });
        });

        // Initial load
        loadUsers();
    });
</script>

</body>
</html>

